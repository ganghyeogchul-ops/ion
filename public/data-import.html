<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„° ê°€ì ¸ì˜¤ê¸° - ì•„ì´ì˜¨ í¬ëŸ¼</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .import-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: var(--dark-secondary);
            border-radius: 10px;
        }
        .import-section {
            margin: 30px 0;
            padding: 20px;
            background: var(--dark-bg);
            border-radius: 8px;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin: 20px 0;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        .file-input-label {
            padding: 15px 30px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .file-input-label:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        .file-name {
            margin: 10px 0;
            padding: 10px;
            background: var(--dark-tertiary);
            border-radius: 5px;
        }
        .import-btn {
            padding: 15px 30px;
            font-size: 16px;
            margin: 10px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success { background: var(--success-color); color: white; }
        .error { background: var(--danger-color); color: white; }
        .warning { background: var(--warning-color); color: white; }
        .info { background: var(--primary-color); color: white; }
        .progress-info {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--dark-tertiary);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="import-container">
        <h1><i class="fas fa-upload"></i> ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</h1>
        <p>ë‚´ë³´ë‚¸ JSON íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë°ì´í„°ë¥¼ ë³µì›í•©ë‹ˆë‹¤.</p>

        <div class="import-section">
            <h3><i class="fas fa-file-import"></i> íŒŒì¼ ì„ íƒ</h3>
            
            <div class="file-input-wrapper">
                <label for="fileInput" class="file-input-label">
                    <i class="fas fa-folder-open"></i> JSON íŒŒì¼ ì„ íƒ
                </label>
                <input type="file" id="fileInput" accept=".json" onchange="handleFileSelect(event)">
            </div>
            
            <div id="fileName" class="file-name" style="display: none;"></div>
            
            <button id="importBtn" class="btn-primary import-btn" onclick="importData()" style="display: none;">
                <i class="fas fa-cloud-upload-alt"></i> ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘
            </button>
        </div>

        <div id="status"></div>

        <div id="progress" style="display: none;">
            <div class="progress-info">
                <p><strong>ì§„í–‰ ìƒí™©:</strong> <span id="progressText">ì¤€ë¹„ ì¤‘...</span></p>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill">0%</div>
                </div>
            </div>
        </div>

        <div class="import-section">
            <h3><i class="fas fa-exclamation-triangle"></i> ì£¼ì˜ì‚¬í•­</h3>
            <ul>
                <li>âš ï¸ <strong>ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¤‘ë³µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</strong></li>
                <li>ğŸ’¾ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì „ì— ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤</li>
                <li>ğŸ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</li>
                <li>â±ï¸ ë°ì´í„° ì–‘ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            </ul>
        </div>

        <div class="import-section">
            <h3><i class="fas fa-info-circle"></i> ì‚¬ìš© ë°©ë²•</h3>
            <ol>
                <li><strong>ê´€ë¦¬ì ë¡œê·¸ì¸</strong>: ë¨¼ì € ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</li>
                <li><strong>íŒŒì¼ ì„ íƒ</strong>: ë‚´ë³´ë‚¸ JSON íŒŒì¼ ì„ íƒ</li>
                <li><strong>ê°€ì ¸ì˜¤ê¸° ì‹œì‘</strong>: "ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘" ë²„íŠ¼ í´ë¦­</li>
                <li><strong>ì™„ë£Œ ëŒ€ê¸°</strong>: ì§„í–‰ ìƒí™© í™•ì¸ í›„ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°</li>
                <li><strong>í™•ì¸</strong>: í™ˆí˜ì´ì§€ì—ì„œ ë°ì´í„° í™•ì¸</li>
            </ol>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
        let selectedData = null;

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileNameDiv = document.getElementById('fileName');
            const importBtn = document.getElementById('importBtn');
            const statusDiv = document.getElementById('status');

            fileNameDiv.style.display = 'block';
            fileNameDiv.innerHTML = `<i class="fas fa-file-alt"></i> ì„ íƒëœ íŒŒì¼: <strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    selectedData = JSON.parse(e.target.result);
                    
                    statusDiv.innerHTML = `
                        <div class="status success">
                            <i class="fas fa-check-circle"></i> íŒŒì¼ ì½ê¸° ì™„ë£Œ!
                            <ul style="margin-top: 10px; text-align: left;">
                                <li>ê²Œì‹œê¸€: ${selectedData.posts?.length || 0}ê°œ</li>
                                <li>ëŒ“ê¸€: ${selectedData.comments?.length || 0}ê°œ</li>
                                <li>ê±°ë˜ì‹ ì²­: ${selectedData.trade_requests?.length || 0}ê°œ</li>
                                <li>íšŒì›: ${selectedData.members?.length || 0}ê°œ</li>
                            </ul>
                        </div>
                    `;
                    
                    importBtn.style.display = 'inline-block';
                } catch (error) {
                    statusDiv.innerHTML = `<div class="status error"><i class="fas fa-exclamation-circle"></i> íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`;
                    importBtn.style.display = 'none';
                }
            };
            reader.readAsText(file);
        }

        async function importData() {
            if (!selectedData) {
                alert('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!confirm('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ë°ì´í„°ì™€ ì¤‘ë³µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                return;
            }

            const statusDiv = document.getElementById('status');
            const progressDiv = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const importBtn = document.getElementById('importBtn');

            importBtn.disabled = true;
            progressDiv.style.display = 'block';

            try {
                let totalItems = 0;
                let completedItems = 0;

                // ì „ì²´ í•­ëª© ìˆ˜ ê³„ì‚°
                totalItems += selectedData.posts?.length || 0;
                totalItems += selectedData.comments?.length || 0;
                totalItems += selectedData.trade_requests?.length || 0;
                totalItems += selectedData.members?.length || 0;

                // ê²Œì‹œê¸€ ê°€ì ¸ì˜¤ê¸°
                if (selectedData.posts && selectedData.posts.length > 0) {
                    progressText.textContent = 'ê²Œì‹œê¸€ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                    for (const post of selectedData.posts) {
                        try {
                            await fetch('tables/posts', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(post)
                            });
                            completedItems++;
                            const percent = Math.round((completedItems / totalItems) * 100);
                            progressFill.style.width = percent + '%';
                            progressFill.textContent = percent + '%';
                        } catch (error) {
                            console.error('ê²Œì‹œê¸€ ì¶”ê°€ ì˜¤ë¥˜:', error);
                        }
                    }
                }

                // ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°
                if (selectedData.comments && selectedData.comments.length > 0) {
                    progressText.textContent = 'ëŒ“ê¸€ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                    for (const comment of selectedData.comments) {
                        try {
                            await fetch('tables/comments', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(comment)
                            });
                            completedItems++;
                            const percent = Math.round((completedItems / totalItems) * 100);
                            progressFill.style.width = percent + '%';
                            progressFill.textContent = percent + '%';
                        } catch (error) {
                            console.error('ëŒ“ê¸€ ì¶”ê°€ ì˜¤ë¥˜:', error);
                        }
                    }
                }

                // ê±°ë˜ì‹ ì²­ ê°€ì ¸ì˜¤ê¸°
                if (selectedData.trade_requests && selectedData.trade_requests.length > 0) {
                    progressText.textContent = 'ê±°ë˜ì‹ ì²­ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                    for (const request of selectedData.trade_requests) {
                        try {
                            await fetch('tables/trade_requests', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(request)
                            });
                            completedItems++;
                            const percent = Math.round((completedItems / totalItems) * 100);
                            progressFill.style.width = percent + '%';
                            progressFill.textContent = percent + '%';
                        } catch (error) {
                            console.error('ê±°ë˜ì‹ ì²­ ì¶”ê°€ ì˜¤ë¥˜:', error);
                        }
                    }
                }

                // íšŒì› ê°€ì ¸ì˜¤ê¸°
                if (selectedData.members && selectedData.members.length > 0) {
                    progressText.textContent = 'íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                    for (const member of selectedData.members) {
                        try {
                            await fetch('tables/members', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(member)
                            });
                            completedItems++;
                            const percent = Math.round((completedItems / totalItems) * 100);
                            progressFill.style.width = percent + '%';
                            progressFill.textContent = percent + '%';
                        } catch (error) {
                            console.error('íšŒì› ì¶”ê°€ ì˜¤ë¥˜:', error);
                        }
                    }
                }

                statusDiv.innerHTML = `
                    <div class="status success">
                        <i class="fas fa-check-circle"></i> ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!
                        <p style="margin-top: 10px;">ì´ ${completedItems}ê°œ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <p style="margin-top: 10px;"><a href="index.html" class="btn-primary">í™ˆí˜ì´ì§€ë¡œ ì´ë™</a></p>
                    </div>
                `;
                progressText.textContent = 'ì™„ë£Œ!';

            } catch (error) {
                console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                statusDiv.innerHTML = `<div class="status error"><i class="fas fa-exclamation-circle"></i> ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
                importBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
